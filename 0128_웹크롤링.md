# 웹 크롤링

## 1. 설명

### [1] 프로토콜
통신 프로토콜 또는 통신 규약은 컴퓨터나 원거리 통신 장비 사이에서 **메시지를 주고 받는 양식과 규칙의 체계**이다. 통신 프로토콜은 신호 체계, 인증, 그리고 오류 감지 및 수정 기능을 포함할 수 있다. [위키피디아](
https://ko.m.wikipedia.org/wiki/%ED%86%B5%EC%8B%A0_%ED%94%84%EB%A1%9C%ED%86%A0%EC%BD%9C)

요청과 응답을 하는 규약, 약속



### [2] HTTP
HTTP(HyperText Transfer Protocol, 문화어: 초본문전송규약, 하이퍼본문전송규약)는 W3 상에서 정보를 주고받을 수 있는 프로토콜이다. 주로 HTML 문서를 주고받는 데에 쓰인다. [위키피디아](https://ko.m.wikipedia.org/wiki/HTTP)

### [3] 요청과 응답

#### (1) 요청
+ URL로 요청
+ 클라이언트 (정보를 원하는 사람)

#### (2) 응답
+ 문서 (HTML, XML, JSON) 으로 응답

+ 서버 (정보를 주는 사람)

+ 웹페이지는 사실 문서

  

#### (3) 예
+ 브라우저를 통해 주소로 요청보내고, 받은 응답(문서)을 브라우저가 웹 화면으로 렌더링 (크롬 등)
+ 파이썬을 통해 주소로 요청보내고, 받은 응답(문서)을 파이썬으로 처리, 조작 함



## 2. 파이썬을 이용해 하는 방법
+ ```requests``` 라이브러리 이용 [공식문서](https://docs.python-requests.org/en/latest/) / [requests ](https://docs.python-requests.org/en/latest/user/quickstart/#make-a-request) 부분
  + HTTP로 요청과 응답을 하는 라이브러리
+ ```BeautifulSoup``` 라이브러리 이용 [공식문서]()
  + HTML, XML 파일로 부터 데이터를 가져오는 라이브러리
+ ```requests.get()```할 때, API의 요청변수 중 **필수**인 것들은 꼭 ```params```에 넣어줘야 함


### [1] json으로 가져오는 경우
+ 크롬 확장자에 json viewer 추가하면 json 파일 깔끔하게 볼 수 있음

+ 아래와 같이 바로 ```dict```로 class 변경 가능함

  

#### (1) URL 이용 (m.stock.naver.com 예)
```python
# 0. Get URL
# 0 - 1. m.stock.naver.com 접속 -> 국내

# 0 - 2. 우클릭 -> 검사 -> Network -> all -> KOSPI?page=1&pageSize=20 선택

# 0 - 3. Preview 에서 볼 수 있고, Headers에서 URL 복사해서 크롬(웹)에서 이용가능


# 1. URL
URL = 'https://m.stock.naver.com/api/stocks/marketValue/KOSPI?page=1&pageSize=20'

import requests

# 2. 요청과 응답
reponse = requests.get(URL).json()
type(response)
>>> <class 'dict'>
```



#### (2) URL + path, params 이용

```python
# 0. Get URL
# 0 - 1. m.stock.naver.com 접속 -> 국내

# 0 - 2. 우클릭 -> 검사 -> Network -> all -> KOSPI?page=1&pageSize=20 선택

# 0 - 3. Preview 에서 볼 수 있고, Headers에서 URL 복사해서 크롬(웹)에서 이용가능


# 1. URL의 '?' 뒷 부분은 params로 넘겨주기
#URL = 'https://m.stock.naver.com/api/stocks/marketValue/KOSPI?page=1&pageSize=20'
URL = 'https://m.stock.naver.com/api/stocks'
path = '/marketValue/KOSPI'

params = {'page' : '1', 'pageSize' : '20'}


import requests

# 2. 요청과 응답
reponse = requests.get(URL+path, params = params).json()
type(response)
>>> <class 'dict'>
```





### [2] HTML로 가져오는 경우

+ 네이버 증시에서 코스피 가져오기 예

  ```python
  import requests
  
  # 1. 주소
  URL = 'https://finance.naver.com/sise/'
  
  
  ## 2. 요청하고 정보 받아오기
  ## 2 - 1. 요청
  #https://docs.python-requests.org/en/latest/user/quickstart/#make-a-request
  response = requests.get(URL)
  print(response, type(response))
  # Response [200] : 성공적으로 데이터 가져옴
  >>> <Response [200]> <class 'requests.models.Response'>  # 응답성공유무 / 응답 type
  
  ## 2 - 2. text로 변경
  response = response.text  # HTML 임
  print(type(response))
  >>> <class 'str'>
  
  
  ### 3. 내가 원하는 정보 얻기
  ### 3 - 1. HTML을 읽기위해 Type 변경
  from bs4 import BeautifulSoup
  ### text(str) -> 다른 객체로 변환
  data = BeautifulSoup(response, 'html.parser')
  
  ### data와 response의 내용은 같지만, class 가 다르다.
  print(type(data), type(response))
  >>> <class 'bs4.BeautifulSoup'> <class 'str'>
  
  
  ### 3 - 2. copy selector 이용 (개발자모드(F12) -> Elements -> 우클릭 -> copy selector)
  kospi = data.select_one('#KOSPI_now') # copy selector 로 id인 #KOSPI_now 가져옴
  print(kospi)
  >>> <span class="num" id="KOSPI_now">2,663.34</span>
  
  ### 3 - 3. text만 가져오기
  print(kospi.text)
  >>> 2,592.49
  ```
  
  1. ```requests.get(URL).text : (str class , html) ```
  
  2. ```BeautifulSoup(response, 'html.parser') : (bs4.BeautifulSoup class, html) ```
  
  3. ```.select_one(copy selector) -> .text : 원하는 숫자 결과```
  
     

### [3] TMDB 예

+ 영화 정보 사이트인 TMDB를 이용하여, 영화를 추천해 보기

  1. 제일 먼저 할 것은 [홈페이지](https://www.themoviedb.org/) &rarr; 프로필 &rarr; 설정 &rarr; 좌측탭 API에서 API 키 요청

  2. [홈페이지](https://www.themoviedb.org/) &rarr; [최하단 API 탭](https://www.themoviedb.org/documentation/api) &rarr; [develpoers.themoviedb.org](https://developers.themoviedb.org/3/getting-started/introduction) &rarr; [좌측탭 Moives](https://developers.themoviedb.org/3/movies/get-movie-details) 에서 여러가지 정보 이용가능

  + ```path = ``` details, credits(사람), recommendations, release dates, reviews, similar movies 등 이용가능

  ```python
  # 0. import
  import requests
  
  # 1. URL 및 요청변수 설정
  # https://developers.themoviedb.org/3/movies/get-now-playing
  
  BASE_URL = 'https://api.themoviedb.org/3'
  path = '/movie/now_playing'
  params = {
      'api_key' : '24e3cecec267fb2bda3ef5da254574f6',  # 요청하여 받은 api key
      'region' : 'KOR',
      'language' : 'ko'
  }
  
  # 위의 url은 결국 https://api.themoviedb.org/3/movie/now_playing?api_key=092c6e882c0a6a4ee07e0bd1651811c8&region=KR&language=ko 와 같음
  
  ## 2. 요청 보낸 결과 저장
  response = requests.get(BASE_URL + path, params = params)
  
  
  #### 3. 조작
  print(response)
  >>> <Response [200]>  # 만약 주소 잘못되었다면, >>> <Response [404]>
  ```

  

### [4] 공공데이터포털

+ [공공데이터포털]('https://www.data.go.kr/index.do')에서 오픈 API 데이터들을 받아올 수 있음
  + 메인화면 &rarr; 데이터찾기 &rarr; 데이터목록 &rarr; 오픈 API 탭 &rarr; 원하는 데이터 클릭 &rarr; 하단에 python 예시코드 활용 (api key(서비스키)의 경우 데이터 활용 요청을 하면 받을 수 있음 :  decode key 이용)



## 3. API

### (1) 인터페이스 [(위키피디아)](https://ko.m.wikipedia.org/wiki/%EC%9D%B8%ED%84%B0%ED%8E%98%EC%9D%B4%EC%8A%A4_(%EC%BB%B4%ED%93%A8%ED%8C%85))
+ 인터페이스(interface)는 서로 다른 두 개의 시스템, 장치 사이에서 정보나 신호를 주고받는 경우의 접점이나 경계면이다. 즉, 사용자가 기기를 쉽게 동작시키는데 도움을 주는 시스템을 의미한다. 컴퓨팅에서 컴퓨터 시스템끼리 정보를 교환하는 공유 경계이다. 이러한 교환은 소프트웨어, 컴퓨터 하드웨어, 주변기기, 사람 간에 이루어질 수 있으며, 서로 복합적으로 이루어질 수도 있다. 

### (2) API [(위키피디아)](https://ko.m.wikipedia.org/wiki/API)
+ API(Application Programming Interface 애플리케이션 프로그래밍 인터페이스[*], 응용 프로그램 프로그래밍 인터페이스)는 컴퓨터나 컴퓨터 프로그램 사이의 연결이다. 일종의 소프트웨어 인터페이스이며 다른 종류의 소프트웨어에 서비스를 제공한다
+ 컴퓨터와 인간을 연결시키는 사용자 인터페이스와 반대로, API는 컴퓨터나 소프트웨어를 서로 연결한다

+ API의 핵심은 정의된 프로토콜을 기반으로 상호 작용을 할 수 있도록 일종의 약속된 시스템이라고 볼 수 있다 [나무위키](https://namu.wiki/w/API)

+ 즉 응용프로그램 간에 데이터를 주고 받는 방법이라고 생각할 수 있음


## 4. API 활용법

### [1] 요청방식 이해
+ 인증 방식
+ URL 생성
  + 기본 주소 (BASE_URL)
  + 원하는 요소에 대한 추가 경로 (path)
  + 요청변수 (required or optional) (params)
    + api key는 반드시 필요

 ### [2] 응답결과 이해
 + 응답결과 타입 (JSON, HTML, XML)
 + 응답결과 구조


 ### [3] Error
 + 400번대 Error : 사용자 실수
 + 500번대 Error : 서버(개발자) 실수
